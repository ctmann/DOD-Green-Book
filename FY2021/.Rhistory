valid.names.public.law.titles,
my.table.number,
dod.service){
#Import
outlays.1 <- read_excel(file.name, na = "0", col_names=F, n_max=34)
#Shaping: Only valid Rows (see "how to update this file/ valid.rows" above)
outlays.1 <- outlays.1[valid.rows,]
# Shaping: Remove unneeded spacer cols
outlays.1 <- outlays.1[, c(-2:-3)]
# Reshaping-#-#-#-#-#-#-#--#-#-#--#-#-#-
#Rename Cols
FY.colnames <- str_c(1948:(1948+(ncol(outlays.1)-2) )) #<FY must be text
colnames(outlays.1) <- c("public.law.title",
FY.colnames)
# NAs to zeros
outlays.1[is.na(outlays.1)] <- 0
#Numbers to unadjusted amounts
# Rename (see above)
outlays.1$public.law.title <- valid.names.public.law.titles
#Add meta cols-#-#-#-#-#-#-#--#-#-#--#-#-#-
#new identifying cols
outlays.1$budget.type   <- "outlays"
outlays.1$service       <- dod.service
outlays.1$source.table  <- my.table.number
#Add constant,current col
# Divide nrows in two; tag first half as "current", and second "constant"
repeat.deflator.type.times <- nrow(outlays.1)/2
repeat.deflator.type <- c( rep("current", repeat.deflator.type.times),
rep("constant", repeat.deflator.type.times) )
outlays.1$deflator.type <-repeat.deflator.type
#Rearrange
outlays.1 <- outlays.1 %>%
select(
budget.type,
service,
source.table,
deflator.type,
public.law.title,
everything() )
#Tidy and formatting-#-#-#-#-#-#-#--#-#-#--#-#-#-
#Tidy
outlays.2 <- outlays.1 %>%
gather(FY, amount, -1:-5)
#adjust numbers
outlays.2$amount <- as.numeric(outlays.2$amount)*1e6
final.outlays <- outlays.2
}
# Apply Function -----------------------------------------------------------
file.name <- paste0(chapter.6.raw.data.folder, tbl.6.16.Army)
my.table.number <- "6.16"
dod.service <- "army"
army.df <- nettle_clean( file.name,
valid.rows,
valid.names.public.law.titles,
my.table.number,
dod.service)
file.name <- paste0(chapter.6.raw.data.folder, tbl.6.17.Navy)
my.table.number <- "6.17"
dod.service <- "navy"
navy.df <- nettle_clean( file.name,
valid.rows,
valid.names.public.law.titles,
my.table.number,
dod.service)
file.name <- paste0(chapter.6.raw.data.folder, tbl.6.18.USAF)
my.table.number <- "6.18"
dod.service <- "usaf"
usaf.df <- nettle_clean( file.name,
valid.rows,
valid.names.public.law.titles,
my.table.number,
dod.service)
# Comine datasets
combined.toa <- bind_rows(army.df, navy.df,usaf.df)
#' Table 6.19-6.21 DOD BA By by Service and Title
#'
#'
#' Download raw files to temp folder locally for processing
#' Raw files stored in subfolder are not necessary
#'
#' # How to Update this File -------------------------------------------------
#'
#'   1) Set working Directory to current year:
setwd("./DOD-Green-Book/FY2021")
#'
#'   2) Download Comptroller data to Raw folder (manually).
#'
#'   3) Update name of Chapter 6 raw data folder, files
chapter.6.raw.data.folder <- "./Data/Raw/FY21 PB Green Book Chap 6/"
#'
#'   4) Update Name of specific files
tbl.6.19.Army <- "FY21 PB Green Book Table 6-19.xlsx"
tbl.6.20.Navy <- "FY21 PB Green Book Table 6-20.xlsx"
tbl.6.21.USAF <- "FY21 PB Green Book Table 6-21.xlsx"
#'   5) Set current year
current.FY <- 2021
#'  6) Shape of each df may change. Currently:
#'       Current dollars:  7 (MILPERS) :14 (Trust, Receipts, and Other)
#'       Constant Dollars: 16 (MILPERS):24 (Trust, Receipts, and Other)
# Libraries ---------------------------------------------------------------
library(tidyverse)
library(readxl)
library(stringr)
# Comm Vars, Functions ---------------------------------------------------------------
# None
#Testing Purposes
#file.name <- paste0(file.location, tbl.6.19.Army)
# Create Clean Function ----------------------------------------------------------
nettle_clean <- function(file.name,
my.table.number,
dod.service,
current.FY){
# Due to missing column names, read_excel requires col_names = False
orig <-  read_excel(paste0(file.name),
na = "0", skip = 4, col_names = TRUE)
##--Shaping Paramters may change (Current/Constant)
# Basic Shaping (remove blank cols)
orig <- orig %>%
select(-2,-3)
# create Universal Col Header
my.col.header <- c("Public Law Title", fiscal.years)
names(orig) <- my.col.header
## End orig---
# !!DANGER: ASSUMES DF ROWS (CURRENT/CONSTANT) SAME SIZE FROM YEAR TO YEAR
current <- orig %>%
slice(2:9) %>% #< This assumes no more accounts will be added. In FY2020, one was.
mutate(deflator.type = "current")
## Splice off "Constant Dollars" amounts
constant  <- orig %>%
slice(12:19) %>% #< This assumes no more accounts will be added. In FY2020, one was.
mutate(deflator.type = "constant")
##--COMBINE Current/Constant
# Combine Current and Constant Datasets
combined <- bind_rows(constant, current)
# Tidy
tidied <- combined %>%
gather(FY, Amount, -`Public Law Title`,-deflator.type)
# Format Fixing
# Convert String to Millions
tidied$Amount <- as.numeric(tidied$Amount)
tidied$Amount <- tidied$Amount *1e6
# Replace NAs with 0
tidied <- tidied %>%
replace_na(list(Amount = 0))
# Meta --------------------------------------------------------------
# Add Source Notes
tidied$data.notes <- "All enacted war and supplemental funding is included; Includes both discretionary and mandatory "
tidied$source.table <- my.table.number
tidied$Service <- my.dod.service
return(tidied)
}
# Use  -----------------------------------------------------------------
# Download the file with nettle function (Assume Identical Shape of Separate Tabs)
#   nettle_clean requires four inputs
#   the last two are for print purposes
#   Inputs: zip.url, spreadsheet.name, my.table.number, dod.service
# Download 6-19
file.name <- paste0(chapter.6.raw.data.folder,tbl.6.19.Army)
my.table.number <- "tbl.6-19"
my.dod.service <- "Army"
army <- nettle_clean(file.name = file.name,
my.table.number,
my.dod.service)
# Download 6-20
file.name <- paste0(chapter.6.raw.data.folder,tbl.6.20.Navy)
my.table.number <- "tbl.6-20"
my.dod.service <- "Navy"
navy <- nettle_clean(file.name = file.name,
my.table.number,
my.dod.service)
# Download 6-21
file.name <- paste0(chapter.6.raw.data.folder, tbl.6.21.USAF)
my.table.number <- "tbl.6-21"
my.dod.service <- "Air.Force"
air.force <- nettle_clean(file.name = file.name,
my.table.number,
my.dod.service)
# tidy --------------------------------------------------------------------
ba.by.title <- bind_rows(army, navy, air.force) %>%
filter(complete.cases(.)) %>%
mutate(`Public Law Title` = str_replace_all(`Public Law Title`, "\\.","") %>% str_trim() )
#Rearrange to sensible order
ba.by.title <- ba.by.title %>%
select(Service,
`Public Law Title`,
FY,
deflator.type,
Amount,
source.table,
data.notes)
combined.ba <- ba.by.title
#' Table 6.19-6.21 DOD BA By by Service and Title
#'
#'
#' Download raw files to temp folder locally for processing
#' Raw files stored in subfolder are not necessary
#'
#' # How to Update this File -------------------------------------------------
#'
#'   1) Set working Directory to current year:
setwd("./DOD-Green-Book/FY2021")
#'
#'   2) Download Comptroller data to Raw folder (manually).
#'
#'   3) Update name of Chapter 6 raw data folder, files
chapter.6.raw.data.folder <- "./Data/Raw/FY21 PB Green Book Chap 6/"
#'
#'   4) Update Name of specific files
tbl.6.19.Army <- "FY21 PB Green Book Table 6-19.xlsx"
tbl.6.20.Navy <- "FY21 PB Green Book Table 6-20.xlsx"
tbl.6.21.USAF <- "FY21 PB Green Book Table 6-21.xlsx"
#'   5) Set current year
current.FY <- 2021
#'  6) Shape of each df may change. Currently:
#'       Current dollars:  7 (MILPERS) :14 (Trust, Receipts, and Other)
#'       Constant Dollars: 16 (MILPERS):24 (Trust, Receipts, and Other)
# Libraries ---------------------------------------------------------------
library(tidyverse)
library(readxl)
library(stringr)
# Comm Vars, Functions ---------------------------------------------------------------
# None
#Testing Purposes
#file.name <- paste0(file.location, tbl.6.19.Army)
# Create Clean Function ----------------------------------------------------------
nettle_clean <- function(file.name,
my.table.number,
dod.service,
current.FY){
# Due to missing column names, read_excel requires col_names = False
orig <-  read_excel(paste0(file.name),
na = "0", skip = 4, col_names = TRUE)
##--Shaping Paramters may change (Current/Constant)
# Basic Shaping (remove blank cols)
orig <- orig %>%
select(-2,-3)
# create Universal Col Header
my.col.header <- c("Public Law Title", fiscal.years)
names(orig) <- my.col.header
## End orig---
# !!DANGER: ASSUMES DF ROWS (CURRENT/CONSTANT) SAME SIZE FROM YEAR TO YEAR
current <- orig %>%
slice(2:9) %>% #< This assumes no more accounts will be added. In FY2020, one was.
mutate(deflator.type = "current")
## Splice off "Constant Dollars" amounts
constant  <- orig %>%
slice(12:19) %>% #< This assumes no more accounts will be added. In FY2020, one was.
mutate(deflator.type = "constant")
##--COMBINE Current/Constant
# Combine Current and Constant Datasets
combined <- bind_rows(constant, current)
# Tidy
tidied <- combined %>%
gather(FY, Amount, -`Public Law Title`,-deflator.type)
# Format Fixing
# Convert String to Millions
tidied$Amount <- as.numeric(tidied$Amount)
tidied$Amount <- tidied$Amount *1e6
# Replace NAs with 0
tidied <- tidied %>%
replace_na(list(Amount = 0))
# Meta --------------------------------------------------------------
# Add Source Notes
tidied$data.notes <- "All enacted war and supplemental funding is included; Includes both discretionary and mandatory "
tidied$source.table <- my.table.number
tidied$Service <- my.dod.service
return(tidied)
}
# Use  -----------------------------------------------------------------
# Download the file with nettle function (Assume Identical Shape of Separate Tabs)
#   nettle_clean requires four inputs
#   the last two are for print purposes
#   Inputs: zip.url, spreadsheet.name, my.table.number, dod.service
# Download 6-19
file.name <- paste0(chapter.6.raw.data.folder,tbl.6.19.Army)
my.table.number <- "tbl.6-19"
my.dod.service <- "Army"
army <- nettle_clean(file.name = file.name,
my.table.number,
my.dod.service)
# Download 6-20
file.name <- paste0(chapter.6.raw.data.folder,tbl.6.20.Navy)
my.table.number <- "tbl.6-20"
my.dod.service <- "Navy"
navy <- nettle_clean(file.name = file.name,
my.table.number,
my.dod.service)
# Download 6-21
file.name <- paste0(chapter.6.raw.data.folder, tbl.6.21.USAF)
my.table.number <- "tbl.6-21"
my.dod.service <- "Air.Force"
air.force <- nettle_clean(file.name = file.name,
my.table.number,
my.dod.service)
# tidy --------------------------------------------------------------------
ba.by.title <- bind_rows(army, navy, air.force) %>%
filter(complete.cases(.)) %>%
mutate(`Public Law Title` = str_replace_all(`Public Law Title`, "\\.","") %>% str_trim() )
#Rearrange to sensible order
ba.by.title <- ba.by.title %>%
select(Service,
`Public Law Title`,
FY,
deflator.type,
Amount,
source.table,
data.notes)
#' Table 6.19-6.21 DOD BA By by Service and Title
#'
#'
#' Download raw files to temp folder locally for processing
#' Raw files stored in subfolder are not necessary
#'
#' # How to Update this File -------------------------------------------------
#'
#'   1) Set working Directory to current year:
setwd("./DOD-Green-Book/FY2021")
#'
#'   2) Download Comptroller data to Raw folder (manually).
#'
#'   3) Update name of Chapter 6 raw data folder, files
chapter.6.raw.data.folder <- "./Data/Raw/FY21 PB Green Book Chap 6/"
#'
#'   4) Update Name of specific files
tbl.6.19.Army <- "FY21 PB Green Book Table 6-19.xlsx"
tbl.6.20.Navy <- "FY21 PB Green Book Table 6-20.xlsx"
tbl.6.21.USAF <- "FY21 PB Green Book Table 6-21.xlsx"
#'   5) Set current year
current.FY <- 2021
#'  6) Shape of each df may change. Currently:
#'       Current dollars:  7 (MILPERS) :14 (Trust, Receipts, and Other)
#'       Constant Dollars: 16 (MILPERS):24 (Trust, Receipts, and Other)
# Libraries ---------------------------------------------------------------
library(tidyverse)
library(readxl)
library(stringr)
# Comm Vars, Functions ---------------------------------------------------------------
# None
#Testing Purposes
#file.name <- paste0(file.location, tbl.6.19.Army)
# Create Clean Function ----------------------------------------------------------
nettle_clean <- function(file.name,
my.table.number,
dod.service,
current.FY){
# Due to missing column names, read_excel requires col_names = False
orig <-  read_excel(paste0(file.name),
na = "0", skip = 4, col_names = TRUE)
##--Shaping Paramters may change (Current/Constant)
# Basic Shaping (remove blank cols)
orig <- orig %>%
select(-2,-3)
# create Universal Col Header
my.col.header <- c("Public Law Title", fiscal.years)
names(orig) <- my.col.header
## End orig---
# !!DANGER: ASSUMES DF ROWS (CURRENT/CONSTANT) SAME SIZE FROM YEAR TO YEAR
current <- orig %>%
slice(2:9) %>% #< This assumes no more accounts will be added. In FY2020, one was.
mutate(deflator.type = "current")
## Splice off "Constant Dollars" amounts
constant  <- orig %>%
slice(12:19) %>% #< This assumes no more accounts will be added. In FY2020, one was.
mutate(deflator.type = "constant")
##--COMBINE Current/Constant
# Combine Current and Constant Datasets
combined <- bind_rows(constant, current)
# Tidy
tidied <- combined %>%
gather(FY, Amount, -`Public Law Title`,-deflator.type)
# Format Fixing
# Convert String to Millions
tidied$Amount <- as.numeric(tidied$Amount)
tidied$Amount <- tidied$Amount *1e6
# Replace NAs with 0
tidied <- tidied %>%
replace_na(list(Amount = 0))
# Meta --------------------------------------------------------------
# Add Source Notes
tidied$data.notes <- "All enacted war and supplemental funding is included; Includes both discretionary and mandatory "
tidied$source.table <- my.table.number
tidied$Service <- my.dod.service
return(tidied)
}
# Use  -----------------------------------------------------------------
# Download the file with nettle function (Assume Identical Shape of Separate Tabs)
#   nettle_clean requires four inputs
#   the last two are for print purposes
#   Inputs: zip.url, spreadsheet.name, my.table.number, dod.service
# Download 6-19
file.name <- paste0(chapter.6.raw.data.folder,tbl.6.19.Army)
my.table.number <- "tbl.6-19"
my.dod.service <- "Army"
army <- nettle_clean(file.name = file.name,
my.table.number,
my.dod.service)
# Download 6-20
file.name <- paste0(chapter.6.raw.data.folder,tbl.6.20.Navy)
my.table.number <- "tbl.6-20"
my.dod.service <- "Navy"
navy <- nettle_clean(file.name = file.name,
my.table.number,
my.dod.service)
# Download 6-21
file.name <- paste0(chapter.6.raw.data.folder, tbl.6.21.USAF)
my.table.number <- "tbl.6-21"
my.dod.service <- "Air.Force"
air.force <- nettle_clean(file.name = file.name,
my.table.number,
my.dod.service)
# tidy --------------------------------------------------------------------
ba.by.title <- bind_rows(army, navy, air.force) %>%
filter(complete.cases(.)) %>%
mutate(`Public Law Title` = str_replace_all(`Public Law Title`, "\\.","") %>% str_trim() )
#Rearrange to sensible order
ba.by.title <- ba.by.title %>%
select(Service,
`Public Law Title`,
FY,
deflator.type,
Amount,
source.table,
data.notes)
army
#' Table 6.19-6.21 DOD BA By by Service and Title
#'
#'
#' Download raw files to temp folder locally for processing
#' Raw files stored in subfolder are not necessary
#'
#' # How to Update this File -------------------------------------------------
#'
#'   1) Set working Directory to current year:
setwd("./DOD-Green-Book/FY2021")
#'
#'   2) Download Comptroller data to Raw folder (manually).
#'
#'   3) Update name of Chapter 6 raw data folder, files
chapter.6.raw.data.folder <- "./Data/Raw/FY21 PB Green Book Chap 6/"
#'
#'   4) Update Name of specific files
tbl.6.19.Army <- "FY21 PB Green Book Table 6-19.xlsx"
tbl.6.20.Navy <- "FY21 PB Green Book Table 6-20.xlsx"
tbl.6.21.USAF <- "FY21 PB Green Book Table 6-21.xlsx"
#'   5) Set current year
current.FY <- 2021
#'  6) Shape of each df may change. Currently:
#'       Current dollars:  7 (MILPERS) :14 (Trust, Receipts, and Other)
#'       Constant Dollars: 16 (MILPERS):24 (Trust, Receipts, and Other)
# Libraries ---------------------------------------------------------------
library(tidyverse)
library(readxl)
library(stringr)
# Comm Vars, Functions ---------------------------------------------------------------
# None
#Testing Purposes
#file.name <- paste0(file.location, tbl.6.19.Army)
# Create Clean Function ----------------------------------------------------------
nettle_clean <- function(file.name,
my.table.number,
dod.service,
current.FY){
# Due to missing column names, read_excel requires col_names = False
orig <-  read_excel(paste0(file.name),
na = "0", skip = 4, col_names = TRUE)
##--Shaping Paramters may change (Current/Constant)
# Basic Shaping (remove blank cols)
orig <- orig %>%
select(-2,-3)
# create Universal Col Header
my.col.header <- c("Public Law Title", fiscal.years)
names(orig) <- my.col.header
## End orig---
# !!DANGER: ASSUMES DF ROWS (CURRENT/CONSTANT) SAME SIZE FROM YEAR TO YEAR
current <- orig %>%
slice(2:9) %>% #< This assumes no more accounts will be added. In FY2020, one was.
mutate(deflator.type = "current")
## Splice off "Constant Dollars" amounts
constant  <- orig %>%
slice(12:19) %>% #< This assumes no more accounts will be added. In FY2020, one was.
mutate(deflator.type = "constant")
##--COMBINE Current/Constant
# Combine Current and Constant Datasets
combined <- bind_rows(constant, current)
# Tidy
tidied <- combined %>%
gather(FY, Amount, -`Public Law Title`,-deflator.type)
# Format Fixing
# Convert String to Millions
tidied$Amount <- as.numeric(tidied$Amount)
tidied$Amount <- tidied$Amount *1e6
# Replace NAs with 0
tidied <- tidied %>%
replace_na(list(Amount = 0))
# Meta --------------------------------------------------------------
# Add Source Notes
tidied$data.notes <- "All enacted war and supplemental funding is included; Includes both discretionary and mandatory "
tidied$source.table <- my.table.number
tidied$Service <- my.dod.service
return(tidied)
}
file.name <- paste0(chapter.6.raw.data.folder,tbl.6.19.Army)
my.table.number <- "tbl.6-19"
my.dod.service <- "Army"
army <- nettle_clean(file.name = file.name,
my.table.number,
my.dod.service)
chapter.6.raw.data.folder
tbl.6.19.Army
nettle_clean(file.name = file.name,
my.table.number,
my.dod.service)
