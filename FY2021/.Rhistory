"strategic.forces",
"general.purpose.forces",
"C3.intel.and.space",
"mobility.forces",
"guard.and.reserve.forces",
"research.and.development",
"central.supply.and.maintenance",
"training.medical.and.other",
"administration.and.associated",
"support.of.other.nations",
"special.operations.forces",
"space",
"OCO.placeholder",
"other"
)
# Libraries ---------------------------------------------------------------
library(tidyverse)
library(readxl)
library(stringr)
# Common Vars and Functions -----------------------------------------------
# filename
import.file.name.1 <- paste0(chapter.6.raw.data.folder,
my.filename.1)
import.file.name.2 <- paste0(chapter.6.raw.data.folder,
my.filename.2)
#ranges
col.limit <- ( (current.FY + 4) - 1962) + first.row.of.data #<-begin in FY1962
my.range <- str_c("A",first.row.of.data,
":",
"P", col.limit)
# export labelling
mylocation <- "./Data/Processed"
mydate <- paste('Updated', format(Sys.time(), format = "_%Y-%m-%d_%H%M") , sep = "")
my.export.filename <- sprintf("%s/%s_%s.csv", mylocation, source.table.all, mydate)
# Methodology -------------------------------------------------------------
#' Cut up the datasets, combine, then clean all
#Import
df.1 <- bind_rows(
read_excel(import.file.name.1,
range=my.range,
col_names=F),
read_excel(import.file.name.2,
range=my.range,
col_names=F)
)
# Shaping: Remove unneeded  cols
df.1 <- df.1[, -2]
# Reshaping-#-#-#-#-#-#-#--#-#-#--#-#-#-
#FY column
df.1[,1] <- str_c(rep(str_c(1962:(current.FY + 4) ),2) )
# Rename (see above)
names(df.1) <- valid.names
# NAs to zeros
df.1[is.na(df.1)] <- 0
#Add meta cols-#-#-#-#-#-#-#--#-#-#--#-#-#-
#new identifying cols
df.1$budget.type        <-    budget.type
df.1$deflator.type      <-    c( rep("current", nrow(df.1)/2),
rep("constant",nrow(df.1)/2))
df.1$source.table       <-    c( rep(source.table.1, nrow(df.1)/2),
rep(source.table.2, nrow(df.1)/2))
#Rearrange
df.1 <- df.1 %>%
select(
source.table,
budget.type,
deflator.type,
#spending.category,
everything() )
#Tidy and formatting-#-#-#-#-#-#-#--#-#-#--#-#-#-
#Tidy
df.2 <- df.1 %>%
gather(major.force.program, amount, -1:-4)
#adjust numbers
df.2$amount <- as.numeric(df.2$amount)*1e6
final.df <- df.2
write_csv(final.df, my.export.filename)
#' Original DoD Comptroller zip file downloaded here:
#' http://comptroller.defense.gov/BudgetMaterials.aspx
#' To View as pd:
#' http://comptroller.defense.gov/Portals/45/Documents/defbudget/fy2019/FY19_Green_Book.pdf
#'
#' To download as zip
#' http://comptroller.defense.gov/Portals/45/Documents/defbudget/fy2019/FY_2019_Green_Book.zip
#'
#' Table 6.8 DOD BA By Title
#'
# Libraries ---------------------------------------------------------------
library(tidyr)
library(dplyr)
library(readxl)
library(stringr)
library(readr)
#' # Import  Data ------------------------------------------------------------
x <- "http://comptroller.defense.gov/Portals/45/Documents/defbudget/fy2019/FY_2019_Green_Book.zip"
y <- "FY19 PB Green Book Chap 6/FY19 6-8_DoD BA by Title.xlsx"
nettle_downzip <- function(zip.url, zip.file){
my.temporary.zipped.file <- tempfile()   # Zip file will go in here
my.temporarary.zipped.folder <- tempdir() # Unzipped file will go in here
download.file(zip.url, dest = my.temporary.zipped.file) # Download Source Data to Temp file
unzip(my.temporary.zipped.file, exdir = my.temporarary.zipped.folder) # Unzip to Temp directory
location.of.unzipped.file <- paste0(my.temporarary.zipped.folder,"/", zip.file)
return(location.of.unzipped.file )
}
my.filename <- nettle_downzip(x,y)
# Reshape -----------------------------------------------------------------
#excel_sheets(filename)
df.raw <- read_excel(my.filename, skip = 3)
# Flatten -----------------------------------------------------------------
# Shape Subset for Current Dollars
current.df <- df.raw[2:10, -2:-3]
constant.df <- df.raw[15:23, -2:-3]
nettle_tidy <- function(df, type.of.dollars){
x <- gather(df, Fiscal.Year, Amount, -1)
names(x)[1]<- 'Public Law Title'
x$Amount <- x$Amount * 1e6
x$`Public Law Title` <- str_trim(gsub("[0-9.]+", "", x$`Public Law Title`))
x <- separate(x, Fiscal.Year, c('trash', 'FY'), convert = TRUE )
x <- x[,-2]
x$Deflator.Type <- type.of.dollars
x$Source <- "Table 6.8 DOD BA By Title"
return(x)
}
current <- nettle_tidy(current.df, "Current")
constant <- nettle_tidy(constant.df, "Constant")
df.flat<- bind_rows(current, constant)
df.flat
#' # Import  Data ------------------------------------------------------------
x <- "http://comptroller.defense.gov/Portals/45/Documents/defbudget/fy2021/FY_2021_Green_Book.zip"
y <- "FY21 PB Green Book Chap 6/FY21 6-8_DoD BA by Title.xlsx"
x
y
y
x <- "http://comptroller.defense.gov/Portals/45/Documents/defbudget/fy2021/FY_2021_Green_Book.zip"
y <- "FY21 PB Green Book Chap 6/FY21 PB Green Book Table 6-8.xlsx"
nettle_downzip <- function(zip.url, zip.file){
my.temporary.zipped.file <- tempfile()   # Zip file will go in here
my.temporarary.zipped.folder <- tempdir() # Unzipped file will go in here
download.file(zip.url, dest = my.temporary.zipped.file) # Download Source Data to Temp file
unzip(my.temporary.zipped.file, exdir = my.temporarary.zipped.folder) # Unzip to Temp directory
location.of.unzipped.file <- paste0(my.temporarary.zipped.folder,"/", zip.file)
return(location.of.unzipped.file )
}
my.filename <- nettle_downzip(x,y)
my.filename
df.raw <- read_excel(my.filename, skip = 3)
my.filename
my.filename <- nettle_downzip(x,y)
# Info --------------------------------------------------------------------
#' Table 6.8 BA by Public Law Title
#' # How to Update this File -------------------------------------------------
#'
#'   Set working Directory to current year:
setwd("./DOD-Green-Book/FY2021")
#'
#'   Download Comptroller data to Raw folder (manually).
#'
#'   Update name of Chapter 6 raw data folder, files
chapter.6.raw.data.folder <- "./Data/Raw/FY21 PB Green Book Chap 6/"
#'
#'   Update Name of specific files
my.filename <- "FY21 PB Green Book Table 6-8.xlsx"
#'   Set current year
current.FY <- 2021
#'First row of data (not colheader)
first.row.of.data <- 7
#' Identify Metacols
budget.type       <-     "BA"
source.table.1    <-     "tbl.6.08_BA.by.Public.Law.Title"
# Libraries ---------------------------------------------------------------
library(tidyverse)
library(readxl)
library(stringr)
chapter.6.raw.data.folder
my.filename
# filename
import.file.name <- paste0(chapter.6.raw.data.folder,
my.filename)
current.FY
(current.FY + 4) - 1948)
(current.FY + 4)
(current.FY + 4) - 1948
first.row.of.data
# Info --------------------------------------------------------------------
#' Table 6.4 and 6.5 TOA by Major Force Program (Current and Constant)
#' # How to Update this File -------------------------------------------------
#'
#'   Set working Directory to current year:
setwd("./DOD-Green-Book/FY2021")
#'
#'   Download Comptroller data to Raw folder (manually).
#'
#'   Update name of Chapter 6 raw data folder, files
chapter.6.raw.data.folder <- "./Data/Raw/FY21 PB Green Book Chap 6/"
#'
#'   Update Name of specific files
my.filename.1 <- "FY21 PB Green Book Table 6-4.xlsx"
my.filename.2 <- "FY21 PB Green Book Table 6-5.xlsx"
#'   Set current year
current.FY <- 2021
#'First row of data (not colheader)
first.row.of.data <- 6
#' Identify Metacols
budget.type       <-     "TOA"
source.table.1    <-     "tbl.6.04_Current.TOA.by.Major.Force.Program"
source.table.2    <-     "tbl.6.05_Constant.TOA.by.Major.Force.Program"
source.table.all <-     "tbl.6.04.and.6.05_TOA.by.Major.Force.Program"
# names won't change annually?
valid.names <- c(    "FY",
"strategic.forces",
"general.purpose.forces",
"C3.intel.and.space",
"mobility.forces",
"guard.and.reserve.forces",
"research.and.development",
"central.supply.and.maintenance",
"training.medical.and.other",
"administration.and.associated",
"support.of.other.nations",
"special.operations.forces",
"space",
"OCO.placeholder",
"other"
)
# Libraries ---------------------------------------------------------------
library(tidyverse)
library(readxl)
library(stringr)
# Common Vars and Functions -----------------------------------------------
# filename
import.file.name.1 <- paste0(chapter.6.raw.data.folder,
my.filename.1)
import.file.name.2 <- paste0(chapter.6.raw.data.folder,
my.filename.2)
#ranges
col.limit <- ( (current.FY + 4) - 1962) + first.row.of.data #<-begin in FY1962
my.range <- str_c("A",first.row.of.data,
":",
"P", col.limit)
my.range
col.limit
col.limit
row.limit <- ( (current.FY + 4) - 1962) + first.row.of.data #<-begin in FY1962
my.range <- str_c("A",first.row.of.data,
":",
"P", col.limit)
my.range
row.limit
#ranges
row.limit <- ( (current.FY + 4) - 1962) + first.row.of.data #<-begin in FY1962
my.range <- str_c("A",first.row.of.data,
":",
"P", row.limit)
my.range
# Info --------------------------------------------------------------------
#' Table 6.4 and 6.5 TOA by Major Force Program (Current and Constant)
#' # How to Update this File -------------------------------------------------
#'
#'   Set working Directory to current year:
setwd("./DOD-Green-Book/FY2021")
#'
#'   Download Comptroller data to Raw folder (manually).
#'
#'   Update name of Chapter 6 raw data folder, files
chapter.6.raw.data.folder <- "./Data/Raw/FY21 PB Green Book Chap 6/"
#'
#'   Update Name of specific files
my.filename.1 <- "FY21 PB Green Book Table 6-4.xlsx"
my.filename.2 <- "FY21 PB Green Book Table 6-5.xlsx"
#'   Set current year
current.FY <- 2021
#'First row of data (not colheader)
first.row.of.data <- 6
#' Identify Metacols
budget.type       <-     "TOA"
source.table.1    <-     "tbl.6.04_Current.TOA.by.Major.Force.Program"
source.table.2    <-     "tbl.6.05_Constant.TOA.by.Major.Force.Program"
source.table.all <-     "tbl.6.04.and.6.05_TOA.by.Major.Force.Program"
# names won't change annually?
valid.names <- c(    "FY",
"strategic.forces",
"general.purpose.forces",
"C3.intel.and.space",
"mobility.forces",
"guard.and.reserve.forces",
"research.and.development",
"central.supply.and.maintenance",
"training.medical.and.other",
"administration.and.associated",
"support.of.other.nations",
"special.operations.forces",
"space",
"OCO.placeholder",
"other"
)
# Libraries ---------------------------------------------------------------
library(tidyverse)
library(readxl)
library(stringr)
# Common Vars and Functions -----------------------------------------------
# filename
import.file.name.1 <- paste0(chapter.6.raw.data.folder,
my.filename.1)
import.file.name.2 <- paste0(chapter.6.raw.data.folder,
my.filename.2)
#ranges
row.limit <- ( (current.FY + 4) - 1962) + first.row.of.data #<-begin in FY1962
my.range <- str_c("A",first.row.of.data,
":",
"P", row.limit)
# export labelling
mylocation <- "./Data/Processed"
mydate <- paste('Updated', format(Sys.time(), format = "_%Y-%m-%d_%H%M") , sep = "")
my.export.filename <- sprintf("%s/%s_%s.csv", mylocation, source.table.all, mydate)
# Methodology -------------------------------------------------------------
#' Cut up the datasets, combine, then clean all
#Import
df.1 <- bind_rows(
read_excel(import.file.name.1,
range=my.range,
col_names=F),
read_excel(import.file.name.2,
range=my.range,
col_names=F)
)
# Shaping: Remove unneeded  cols
df.1 <- df.1[, -2]
# Reshaping-#-#-#-#-#-#-#--#-#-#--#-#-#-
#FY column
df.1[,1] <- str_c(rep(str_c(1962:(current.FY + 4) ),2) )
# Rename (see above)
names(df.1) <- valid.names
# NAs to zeros
df.1[is.na(df.1)] <- 0
#Add meta cols-#-#-#-#-#-#-#--#-#-#--#-#-#-
#new identifying cols
df.1$budget.type        <-    budget.type
df.1$deflator.type      <-    c( rep("current", nrow(df.1)/2),
rep("constant",nrow(df.1)/2))
df.1$source.table       <-    c( rep(source.table.1, nrow(df.1)/2),
rep(source.table.2, nrow(df.1)/2))
#Rearrange
df.1 <- df.1 %>%
select(
source.table,
budget.type,
deflator.type,
#spending.category,
everything() )
#Tidy and formatting-#-#-#-#-#-#-#--#-#-#--#-#-#-
#Tidy
df.2 <- df.1 %>%
gather(major.force.program, amount, -1:-4)
#adjust numbers
df.2$amount <- as.numeric(df.2$amount)*1e6
final.df <- df.2
Viw(final.df)
View(final.df)
# Info --------------------------------------------------------------------
#' Table 6.4 and 6.5 TOA by Major Force Program (Current and Constant)
#' # How to Update this File -------------------------------------------------
#'
#'   Set working Directory to current year:
setwd("./DOD-Green-Book/FY2021")
#'
#'   Download Comptroller data to Raw folder (manually).
#'
#'   Update name of Chapter 6 raw data folder, files
chapter.6.raw.data.folder <- "./Data/Raw/FY21 PB Green Book Chap 6/"
#'
#'   Update Name of specific files
my.filename.1 <- "FY21 PB Green Book Table 6-4.xlsx"
my.filename.2 <- "FY21 PB Green Book Table 6-5.xlsx"
#'   Set current year
current.FY <- 2021
#'First row of data (not colheader)
first.row.of.data <- 6
# Info --------------------------------------------------------------------
#' Table 6.4 and 6.5 TOA by Major Force Program (Current and Constant)
#' # How to Update this File -------------------------------------------------
#'
#'   Set working Directory to current year:
setwd("./DOD-Green-Book/FY2021")
#'
#'   Download Comptroller data to Raw folder (manually).
#'
#'   Update name of Chapter 6 raw data folder, files
chapter.6.raw.data.folder <- "./Data/Raw/FY21 PB Green Book Chap 6/"
#'
#'   Update Name of specific files
my.filename.1 <- "FY21 PB Green Book Table 6-4.xlsx"
my.filename.2 <- "FY21 PB Green Book Table 6-5.xlsx"
#'   Set current year
current.FY <- 2021
#'First row of data (not colheader)
first.row.of.data <- 6
# Info --------------------------------------------------------------------
#' Table 6.8 BA by Public Law Title
#' # How to Update this File -------------------------------------------------
#'
#'   Set working Directory to current year:
setwd("./DOD-Green-Book/FY2021")
#'
#'   Download Comptroller data to Raw folder (manually).
#'
#'   Update name of Chapter 6 raw data folder, files
chapter.6.raw.data.folder <- "./Data/Raw/FY21 PB Green Book Chap 6/"
#'
#'   Update Name of specific files
my.filename.1 <- "FY21 PB Green Book Table 6-8.xlsx"
#'   Set current year
current.FY <- 2021
# Info --------------------------------------------------------------------
#' Table 6.8 BA by Public Law Title
#' # How to Update this File -------------------------------------------------
#'
#'   Set working Directory to current year:
setwd("./DOD-Green-Book/FY2021")
#'
#'   Download Comptroller data to Raw folder (manually).
#'
#'   Update name of Chapter 6 raw data folder, files
chapter.6.raw.data.folder <- "./Data/Raw/FY21 PB Green Book Chap 6/"
#'
#'   Update Name of specific files
my.filename.1 <- "FY21 PB Green Book Table 6-8.xlsx"
#'   Set current year
current.FY <- 2021
#'First row of data (not colheader)
first.row.of.data <- 7
#' Identify Metacols
budget.type       <-     "BA"
source.table    <-     "tbl.6.08_BA.by.Public.Law.Title"
# names won't change annually?
valid.names <- c(    "military.personnel",
"retired.pay.Defense",
"OM",
"procurement",
"RDTE",
"family.housing",
"revolving.and.management.funds",
"trust.receipts.and.other",
"OCO.placeholder"
)
# filename
import.file.name <- paste0(chapter.6.raw.data.folder,
my.filename)
# Info --------------------------------------------------------------------
#' Table 6.8 BA by Public Law Title
#' # How to Update this File -------------------------------------------------
#'
#'   Set working Directory to current year:
setwd("./DOD-Green-Book/FY2021")
#'
#'   Download Comptroller data to Raw folder (manually).
#'
#'   Update name of Chapter 6 raw data folder, files
chapter.6.raw.data.folder <- "./Data/Raw/FY21 PB Green Book Chap 6/"
#'
#'   Update Name of specific files
my.filename <- "FY21 PB Green Book Table 6-8.xlsx"
#'   Set current year
current.FY <- 2021
#'First row of data (not colheader)
first.row.of.data <- 7
#' Identify Metacols
budget.type       <-     "BA"
source.table    <-     "tbl.6.08_BA.by.Public.Law.Title"
# names won't change annually?
valid.names <- c(    "military.personnel",
"retired.pay.Defense",
"OM",
"procurement",
"RDTE",
"family.housing",
"revolving.and.management.funds",
"trust.receipts.and.other",
"OCO.placeholder"
)
# Libraries ---------------------------------------------------------------
library(tidyverse)
library(readxl)
library(stringr)
# Common Vars and Functions -----------------------------------------------
# filename
import.file.name <- paste0(chapter.6.raw.data.folder,
my.filename)
import.file.name
first.row.of.data
letters[1]
letters[77]
z <- rep(letters,10)
z
z <- rep(letters,100)
z
z <- rep(letters,100)
(current.FY + 4) - 1948)
(current.FY + 4) - 1948
((current.FY + 4) - 1948) + 4
((current.FY + 4) - 1948) + 6
import.file.name
col.limit <- ((current.FY + 4) - 1948) + 6
col.limit
col.limit <- ((current.FY + 4) - 1948) + 6
col.limit
col.limit <- ((current.FY + 4) - 1948) + 3
col.limit
(current.FY + 4)
(current.FY + 4) - 1948)
((current.FY + 4) - 1948)
(current.FY + 4) - 1948)
((current.FY + 4) - 1948)
